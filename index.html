<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0">
    <title>Pocket PRC - Keller Williams</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        // Icons
        const Save = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
        );

        const Upload = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const FileText = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
        );

        const Paperclip = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
        );

        const Trash = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        );

        const Home = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
        );

        function PocketPRC() {
            const [formData, setFormData] = useState({
                propertyAddress: '',
                homesteadExemption: false,
                homesteadAmount: '',
                veteransExemption: false,
                veteransAmount: '',
                treeGrowthExemption: false,
                treeGrowthAmount: '',
                noExemptions: false,
                propertyDataCard: false,
                taxMap: false,
                dateVisited: '',
                currentZoning: '',
                floodZone: '',
                zoningOverlay: '',
                conformsToZoning: '',
                dwellingUnits: '',
                septicInShoreland: '',
                permitsDescription: '',
                codeEnforcementDocs: false,
                zoneOverlays: false,
                recordedSurvey: false,
                easements: false,
                associationDocs: false,
                associationFinancials: false,
                condoCertificate: false,
                septicDesign: false,
                completedBy: '',
                attachments: []
            });

            const [status, setStatus] = useState({ show: false, message: '', type: '' });

            const showStatus = (message, type) => {
                setStatus({ show: true, message, type });
                setTimeout(() => setStatus({ show: false, message: '', type: '' }), 4000);
            };

            const handleChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            // Auto-check when typing amounts
            const handleAmountChange = (field, amountField, value) => {
                setFormData(prev => ({
                    ...prev,
                    [amountField]: value,
                    [field]: value && parseFloat(value) > 0
                }));
            };

            const handleSave = () => {
                const dataStr = JSON.stringify(formData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                let filename = formData.propertyAddress 
                    ? formData.propertyAddress.replace(/[^a-z0-9]/gi, '_').toLowerCase() 
                    : 'prc_progress';
                filename = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showStatus('‚úÖ Progress saved!', 'success');
            };

            const handleLoad = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (!data.attachments) data.attachments = [];
                            setFormData(data);
                            showStatus('‚úÖ Progress loaded!', 'success');
                        } catch (error) {
                            showStatus('‚ùå Error loading file', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
                event.target.value = '';
            };

            const handleFileUpload = (event) => {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setFormData(prev => ({
                            ...prev,
                            attachments: [...prev.attachments, {
                                name: file.name,
                                data: e.target.result,
                                type: file.type,
                                size: file.size
                            }]
                        }));
                    };
                    reader.readAsDataURL(file);
                });
                showStatus(`üìé Added ${files.length} file(s)`, 'success');
            };

            const removeAttachment = (index) => {
                setFormData(prev => ({
                    ...prev,
                    attachments: prev.attachments.filter((_, i) => i !== index)
                }));
            };

            const generatePDF = async () => {
                try {
                    showStatus('üîÑ Generating PDF...', 'success');

                    const response = await fetch('KW_Maine_Public_Records_Checklist.pdf');
                    const pdfBytes = await response.arrayBuffer();
                    
                    const { PDFDocument } = PDFLib;
                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    const form = pdfDoc.getForm();

                    // Helper functions
                    const setValue = (fieldName, value) => {
                        try {
                            const field = form.getTextField(fieldName);
                            if (value) field.setText(String(value));
                        } catch (e) { console.warn(`Field not found: ${fieldName}`); }
                    };

                    const setCheckbox = (fieldName, isChecked) => {
                        try {
                            const field = form.getCheckBox(fieldName);
                            isChecked ? field.check() : field.uncheck();
                        } catch (e) { console.warn(`Checkbox not found: ${fieldName}`); }
                    };

                    // Fill form fields
                    setValue('Property Address', formData.propertyAddress);
                    
                    setCheckbox('Homestead', formData.homesteadExemption);
                    setCheckbox('Veterans', formData.veteransExemption);
                    setCheckbox('Tree Growth', formData.treeGrowthExemption);
                    setCheckbox('NA', formData.noExemptions);
                    
                    setValue('Homestead $', formData.homesteadAmount);
                    setValue('Veterans $', formData.veteransAmount);
                    setValue('Tree Growth $', formData.treeGrowthAmount);
                    
                    setCheckbox('undefined', formData.propertyDataCard);
                    setCheckbox('undefined_2', formData.taxMap);
                    
                    // Date formatting
                    const dateValue = formData.dateVisited;
                    const formattedDate = dateValue ? new Date(dateValue + 'T00:00:00').toLocaleDateString('en-US') : '';
                    setValue('DATE VISITED', formattedDate);
                    
                    setValue('Current Zone', formData.currentZoning);
                    setValue('Overlay?', formData.zoningOverlay);
                    
                    if (formData.floodZone) {
                        try {
                            form.getRadioGroup('Flood Zone').select(formData.floodZone);
                        } catch (e) { console.warn('Flood Zone error'); }
                    }
                    
                    setValue('2 Does current use appear to conform to zoning restrictions', formData.conformsToZoning);
                    setValue('3 Number of legal dwelling units permitted per ordinance', formData.dwellingUnits);
                    
                    setCheckbox('undefined_3', formData.septicInShoreland === 'Yes');
                    setCheckbox('undefined_4', formData.septicInShoreland === 'No');
                    setCheckbox('undefined_5', formData.septicInShoreland === 'N/A');
                    
                    setValue('5 Record dates  descriptions of permits issued or code enforcement issues if any DO NOT LEAVE BLANK', 
                             formData.permitsDescription);
                    
                    setCheckbox('toggle_12', formData.codeEnforcementDocs);
                    setCheckbox('undefined_6', formData.zoneOverlays);
                    setCheckbox('undefined_7', formData.recordedSurvey);
                    setCheckbox('undefined_8', formData.easements);
                    setCheckbox('undefined_9', formData.associationDocs);
                    setCheckbox('undefined_10', formData.associationFinancials);
                    setCheckbox('undefined_11', formData.condoCertificate);
                    setCheckbox('undefined_12', formData.septicDesign);
                    
                    setValue('4 COMPLETED BY', formData.completedBy);

                    // Attach files
                    for (const attachment of formData.attachments) {
                        try {
                            const base64Data = attachment.data.split(',')[1];
                            const fileBytes = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
                            await pdfDoc.attach(fileBytes, attachment.name, {
                                mimeType: attachment.type || 'application/octet-stream',
                                description: `Attached: ${attachment.name}`
                            });
                        } catch (e) {
                            console.error('Error attaching file:', e);
                        }
                    }

                    // Save and download
                    const pdfBytesOutput = await pdfDoc.save();
                    const blob = new Blob([pdfBytesOutput], { type: 'application/pdf' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    
                    const propertyAddr = formData.propertyAddress || 'Property';
                    const filename = `PRC_${propertyAddr.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                    link.download = filename;
                    link.click();
                    
                    const attachText = formData.attachments.length > 0 ? ` with ${formData.attachments.length} attachment(s)` : '';
                    showStatus(`‚úÖ PDF generated${attachText}!`, 'success');
                } catch (error) {
                    console.error('Error:', error);
                    showStatus('‚ùå Error generating PDF', 'error');
                }
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-red-600 text-white p-4 sticky top-0 z-10 shadow-lg">
                        <div className="max-w-2xl mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Home size={24} />
                                Pocket PRC
                            </h1>
                            <div className="flex gap-2">
                                <button
                                    onClick={handleSave}
                                    className="bg-white text-red-600 px-3 py-2 rounded font-semibold flex items-center gap-2 hover:bg-gray-100"
                                >
                                    <Save />
                                    <span className="hidden sm:inline">Save</span>
                                </button>
                                <label className="bg-white text-red-600 px-3 py-2 rounded font-semibold flex items-center gap-2 cursor-pointer hover:bg-gray-100">
                                    <Upload />
                                    <span className="hidden sm:inline">Load</span>
                                    <input type="file" accept=".json" onChange={handleLoad} className="hidden" />
                                </label>
                                <button
                                    onClick={generatePDF}
                                    className="bg-white text-red-600 px-3 py-2 rounded font-semibold flex items-center gap-2 hover:bg-gray-100"
                                >
                                    <FileText />
                                    <span className="hidden sm:inline">Generate PDF</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Status */}
                    {status.show && (
                        <div className={`max-w-2xl mx-auto mt-4 p-4 rounded-lg ${status.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                            {status.message}
                        </div>
                    )}

                    {/* Form */}
                    <div className="max-w-2xl mx-auto p-4 pb-20">
                        {/* Property Address */}
                        <div className="bg-white rounded-lg shadow p-4 mb-4">
                            <label className="block font-semibold mb-2">Property Address *</label>
                            <input
                                type="text"
                                value={formData.propertyAddress}
                                onChange={(e) => handleChange('propertyAddress', e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="Enter property address"
                            />
                        </div>

                        {/* Section 1: Assessor's Office */}
                        <div className="bg-white rounded-lg shadow p-4 mb-4">
                            <h2 className="text-lg font-bold mb-4 text-red-600">1. ASSESSOR'S OFFICE</h2>
                            
                            <div className="mb-4">
                                <p className="font-semibold mb-2">Tax Exemptions</p>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="checkbox"
                                            checked={formData.homesteadExemption}
                                            onChange={(e) => handleChange('homesteadExemption', e.target.checked)}
                                        />
                                        Homestead $
                                        <input
                                            type="number"
                                            value={formData.homesteadAmount}
                                            onChange={(e) => handleAmountChange('homesteadExemption', 'homesteadAmount', e.target.value)}
                                            className="w-24 p-1 border rounded"
                                            step="0.01"
                                        />
                                    </label>
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="checkbox"
                                            checked={formData.veteransExemption}
                                            onChange={(e) => handleChange('veteransExemption', e.target.checked)}
                                        />
                                        Veterans $
                                        <input
                                            type="number"
                                            value={formData.veteransAmount}
                                            onChange={(e) => handleAmountChange('veteransExemption', 'veteransAmount', e.target.value)}
                                            className="w-24 p-1 border rounded"
                                            step="0.01"
                                        />
                                    </label>
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="checkbox"
                                            checked={formData.treeGrowthExemption}
                                            onChange={(e) => handleChange('treeGrowthExemption', e.target.checked)}
                                        />
                                        Tree Growth $
                                        <input
                                            type="number"
                                            value={formData.treeGrowthAmount}
                                            onChange={(e) => handleAmountChange('treeGrowthExemption', 'treeGrowthAmount', e.target.value)}
                                            className="w-24 p-1 border rounded"
                                            step="0.01"
                                        />
                                    </label>
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="checkbox"
                                            checked={formData.noExemptions}
                                            onChange={(e) => handleChange('noExemptions', e.target.checked)}
                                        />
                                        N/A
                                    </label>
                                </div>
                            </div>

                            <div className="space-y-2">
                                <label className="flex items-center gap-2">
                                    <input
                                        type="checkbox"
                                        checked={formData.propertyDataCard}
                                        onChange={(e) => handleChange('propertyDataCard', e.target.checked)}
                                    />
                                    ATTACH Property Data Card - required
                                </label>
                                <label className="flex items-center gap-2">
                                    <input
                                        type="checkbox"
                                        checked={formData.taxMap}
                                        onChange={(e) => handleChange('taxMap', e.target.checked)}
                                    />
                                    ATTACH Tax Map - required
                                </label>
                            </div>
                        </div>

                        {/* Section 2: Code Enforcement */}
                        <div className="bg-white rounded-lg shadow p-4 mb-4">
                            <h2 className="text-lg font-bold mb-4 text-red-600">2. CODE ENFORCEMENT OFFICE</h2>
                            
                            <div className="mb-4">
                                <label className="block font-semibold mb-2">Date Visited</label>
                                <input
                                    type="date"
                                    value={formData.dateVisited}
                                    onChange={(e) => handleChange('dateVisited', e.target.value)}
                                    className="w-full p-2 border rounded"
                                />
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block font-semibold mb-2">Current Zoning</label>
                                    <input
                                        type="text"
                                        value={formData.currentZoning}
                                        onChange={(e) => handleChange('currentZoning', e.target.value)}
                                        className="w-full p-2 border rounded"
                                    />
                                </div>
                                <div>
                                    <label className="block font-semibold mb-2">Zoning Overlay?</label>
                                    <input
                                        type="text"
                                        value={formData.zoningOverlay}
                                        onChange={(e) => handleChange('zoningOverlay', e.target.value)}
                                        className="w-full p-2 border rounded"
                                    />
                                </div>
                            </div>

                            <div className="mb-4">
                                <p className="font-semibold mb-2">Flood Zone?</p>
                                <div className="flex gap-4">
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="radio"
                                            checked={formData.floodZone === 'Yes'}
                                            onChange={() => handleChange('floodZone', 'Yes')}
                                        />
                                        Yes
                                    </label>
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="radio"
                                            checked={formData.floodZone === 'No'}
                                            onChange={() => handleChange('floodZone', 'No')}
                                        />
                                        No
                                    </label>
                                </div>
                            </div>

                            <div className="mb-4">
                                <label className="block font-semibold mb-2">Does current use appear to conform to zoning restrictions?</label>
                                <input
                                    type="text"
                                    value={formData.conformsToZoning}
                                    onChange={(e) => handleChange('conformsToZoning', e.target.value)}
                                    className="w-full p-2 border rounded"
                                />
                            </div>

                            <div className="mb-4">
                                <label className="block font-semibold mb-2">Number of legal dwelling units permitted per ordinance?</label>
                                <input
                                    type="text"
                                    value={formData.dwellingUnits}
                                    onChange={(e) => handleChange('dwellingUnits', e.target.value)}
                                    className="w-full p-2 border rounded"
                                />
                            </div>

                            <div className="mb-4">
                                <p className="font-semibold mb-2">Septic system located in a shoreland zone?</p>
                                <div className="flex gap-4">
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="radio"
                                            checked={formData.septicInShoreland === 'Yes'}
                                            onChange={() => handleChange('septicInShoreland', 'Yes')}
                                        />
                                        Yes
                                    </label>
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="radio"
                                            checked={formData.septicInShoreland === 'No'}
                                            onChange={() => handleChange('septicInShoreland', 'No')}
                                        />
                                        No
                                    </label>
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="radio"
                                            checked={formData.septicInShoreland === 'N/A'}
                                            onChange={() => handleChange('septicInShoreland', 'N/A')}
                                        />
                                        N/A
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label className="block font-semibold mb-2">Record dates & descriptions of permits issued or code enforcement issues (DO NOT LEAVE BLANK)</label>
                                <textarea
                                    value={formData.permitsDescription}
                                    onChange={(e) => handleChange('permitsDescription', e.target.value)}
                                    className="w-full p-2 border rounded h-32"
                                    placeholder="Enter details here..."
                                />
                            </div>
                        </div>

                        {/* Section 3: Documents */}
                        <div className="bg-white rounded-lg shadow p-4 mb-4">
                            <h2 className="text-lg font-bold mb-4 text-red-600">3. SUBMIT THE FOLLOWING DOCUMENTS</h2>
                            
                            <div className="space-y-2">
                                <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={formData.codeEnforcementDocs} onChange={(e) => handleChange('codeEnforcementDocs', e.target.checked)} />
                                    Pertinent code enforcement file documents
                                </label>
                                <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={formData.zoneOverlays} onChange={(e) => handleChange('zoneOverlays', e.target.checked)} />
                                    Zone Overlays
                                </label>
                                <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={formData.recordedSurvey} onChange={(e) => handleChange('recordedSurvey', e.target.checked)} />
                                    Recorded survey
                                </label>
                                <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={formData.easements} onChange={(e) => handleChange('easements', e.target.checked)} />
                                    Recorded easements, restrictions, covenants
                                </label>
                                <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={formData.associationDocs} onChange={(e) => handleChange('associationDocs', e.target.checked)} />
                                    Association declarations, bylaws, rules/regs
                                </label>
                                <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={formData.associationFinancials} onChange={(e) => handleChange('associationFinancials', e.target.checked)} />
                                    Association financial statements
                                </label>
                                <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={formData.condoCertificate} onChange={(e) => handleChange('condoCertificate', e.target.checked)} />
                                    Condominium resale certificate
                                </label>
                                <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={formData.septicDesign} onChange={(e) => handleChange('septicDesign', e.target.checked)} />
                                    Septic Design (HHE 200)
                                </label>
                            </div>

                            {/* File Attachments */}
                            <div className="mt-6 border-2 border-dashed border-gray-300 rounded-lg p-6">
                                <label className="cursor-pointer">
                                    <div className="text-center">
                                        <Paperclip size={48} className="mx-auto text-gray-400 mb-2" />
                                        <p className="font-semibold mb-1">Click to attach files</p>
                                        <p className="text-sm text-gray-600">PDF, Images, Documents</p>
                                    </div>
                                    <input
                                        type="file"
                                        multiple
                                        accept=".pdf,.jpg,.jpeg,.png,.docx,.xlsx"
                                        onChange={handleFileUpload}
                                        className="hidden"
                                    />
                                </label>

                                {formData.attachments.length > 0 && (
                                    <div className="mt-4 space-y-2">
                                        {formData.attachments.map((att, i) => (
                                            <div key={i} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                <div className="flex items-center gap-2">
                                                    <Paperclip size={16} />
                                                    <span className="text-sm">{att.name}</span>
                                                    <span className="text-xs text-gray-500">({(att.size / 1024).toFixed(1)} KB)</span>
                                                </div>
                                                <button
                                                    onClick={() => removeAttachment(i)}
                                                    className="text-red-600 hover:text-red-800"
                                                >
                                                    <Trash size={16} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Section 4: Completed By */}
                        <div className="bg-white rounded-lg shadow p-4 mb-4">
                            <h2 className="text-lg font-bold mb-4 text-red-600">4. COMPLETED BY</h2>
                            <input
                                type="text"
                                value={formData.completedBy}
                                onChange={(e) => handleChange('completedBy', e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="Your name"
                            />
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<PocketPRC />, document.getElementById('root'));
    </script>
</body>
</html>
